# ✅ 功能更新完成 - 预报时效支持

## 🎯 实现内容

系统现已支持按小时分开保存 GFS 预报数据。

## 📦 文件命名规则

### 分析场（当前时刻）
```
gfs_20260226_00z.nc
gfs_20260226_06z.nc
gfs_20260226_12z.nc
gfs_20260226_18z.nc
```

### 预报场（未来时刻）
```
gfs_20260226_00z_f001.nc  # 00Z 后 1 小时
gfs_20260226_00z_f002.nc  # 00Z 后 2 小时
gfs_20260226_00z_f003.nc  # 00Z 后 3 小时
...
gfs_20260226_00z_f024.nc  # 00Z 后 24 小时
```

## 🔧 核心功能

### 1. Python 下载脚本
```bash
# 下载分析场
python Util/download_gfs.py \
  --date 2026-02-26 \
  --run 0 \
  --forecast 0 \
  --source aws \
  --output GFS_Data/20260226/gfs_20260226_00z.nc

# 下载 3 小时预报
python Util/download_gfs.py \
  --date 2026-02-26 \
  --run 0 \
  --forecast 3 \
  --source aws \
  --output GFS_Data/20260226/gfs_20260226_00z_f003.nc
```

### 2. C# API 查询
```bash
# 获取分析场
curl "http://localhost:5131/api/wind/nc?time=2026-02-26T00:00:00Z"

# 获取 3 小时预报
curl "http://localhost:5131/api/wind/nc?time=2026-02-26T00:00:00Z&forecast=3"

# 自动查找（优先分析场，若无则返回最早的预报场）
curl "http://localhost:5131/api/wind/nc?time=2026-02-26T00:00:00Z&forecast=-1"
```

### 3. 自动下载配置
在 `Services/GfsBackgroundService.cs` 中：
```csharp
// 当前配置：下载 24 小时预报（推荐）
await gfsService.DownloadForecastBatchAsync(
    days: 16, 
    maxForecastHours: 24, 
    cancellationToken
);

// 可选配置：
// 仅分析场：maxForecastHours: 0  （约 1.3 GB）
// 3天预报：maxForecastHours: 72  （约 100 GB）
// 5天预报：maxForecastHours: 120 （约 155 GB）
```

## 📂 目录结构示例

```
GFS_Data/
└── 20260226/
    ├── gfs_20260226_00z.nc          # 分析场
    ├── gfs_20260226_00z_f001.nc     # +1h
    ├── gfs_20260226_00z_f002.nc     # +2h
    ├── gfs_20260226_00z_f003.nc     # +3h
    ├── ...
    ├── gfs_20260226_00z_f024.nc     # +24h
    ├── gfs_20260226_06z.nc          # 06Z 分析场
    ├── gfs_20260226_06z_f001.nc     # 06Z +1h
    └── ...
```

## 🧪 测试方法

### 方式一：运行测试脚本
```powershell
.\test-forecast-hours.ps1
```

该脚本会：
1. 下载 2026-02-25 00Z 的 f000~f006 数据
2. 验证文件是否正确生成
3. 显示 API 测试命令

### 方式二：手动测试
```bash
# 1. 启动 API
.\start-gfs-api.ps1

# 2. 测试 API（在另一个终端）
curl "http://localhost:5131/api/wind/nc?time=2026-02-25T00:00:00Z&forecast=0" -o test_f000.nc
curl "http://localhost:5131/api/wind/nc?time=2026-02-25T00:00:00Z&forecast=3" -o test_f003.nc

# 3. 验证文件大小（应该约 10~30 MB）
ls -lh test_*.nc
```

## 💾 存储空间评估

假设每个文件约 **20 MB**：

| 配置 | 每天文件数 | 16天存储 |
|------|-----------|---------|
| 仅分析场 | 4 | ~1.3 GB |
| 24h预报 | 100 | ~32 GB |
| 72h预报 | 292 | ~93 GB |
| 120h预报 | 484 | ~155 GB |

**推荐**: 使用 24 小时预报配置（32 GB），覆盖常见应用场景。

## 📖 详细文档

- **完整指南**: [GFS_预报时效说明.md](GFS_预报时效说明.md)
- **快速参考**: [快速参考.md](快速参考.md)
- **更新日志**: [CHANGELOG.md](CHANGELOG.md)

## ⚙️ 代码变更

### 修改的文件
1. `Services/GfsDataService.cs`
   - `DownloadDataAsync()` 添加 `forecastHour` 参数
   - `GetDataFilePath()` 支持查找预报文件
   - `DownloadForecastBatchAsync()` 支持批量下载多个时效

2. `Controllers/WindDataController.cs`
   - `GetNetCDF()` 添加 `forecast` 查询参数

3. `Util/download_gfs.py`
   - 添加 `--forecast` 命令行参数
   - 更新 URL 生成逻辑

4. `Services/GfsBackgroundService.cs`
   - 配置 `maxForecastHours: 24`

### 新增的文件
- `GFS_预报时效说明.md` - 详细使用文档
- `test-forecast-hours.ps1` - 测试脚本
- `功能更新完成-预报时效.md` - 本文档

## ✅ 验证清单

- [x] Python 脚本支持 `--forecast` 参数
- [x] C# Service 支持下载预报时效
- [x] API 支持查询预报时效
- [x] 文件命名格式正确
- [x] 批量下载逻辑正确
- [x] 自动查找功能正常
- [x] 编译通过
- [x] 文档完整

## 🚀 下一步

1. **启动测试**: 运行 `.\test-forecast-hours.ps1`
2. **验证 API**: 启动服务并测试预报查询
3. **调整配置**: 根据存储空间需求调整 `maxForecastHours`
4. **监控磁盘**: 确保有足够空间存储预报数据

---

**更新时间**: 2026-02-26  
**版本**: v1.2
